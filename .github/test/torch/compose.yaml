name: torch

networks:
  torch:

services:
  torch:
    restart: unless-stopped
    image: ghcr.io/medizininformatik-initiative/torch:1.0.0-alpha.10
    networks: [ "aether", "torch" ]
    ports: [ ":8080" ]
    environment:
      TORCH_RESULTS_PERSISTENCE: PT12H30M5S
      TORCH_BUFFERSIZE: 100
      # Connection Config
      TORCH_BASE_URL: http://localhost:8080
      TORCH_OUTPUT_FILE_SERVER_URL: http://localhost:80
      TORCH_FLARE_URL: http://torch-flare:8080
      TORCH_FHIR_URL: http://torch-hds:8080/fhir
      # Execution variables
      JAVA_TOOL_OPTIONS: -Xmx8g
      TORCH_USE_CQL: true
      TORCH_FHIR_DISABLE_ASYNC: true
      TORCH_BATCHSIZE: 500
      TORCH_FHIR_PAGE_COUNT: 500
      TORCH_FHIR_MAX_CONNECTIONS: 5
      TORCH_MAXCONCURRENCY: 4
      # Other
      LOG_LEVEL: info
      
    volumes:
      - "./output:/app/output"
    extra_hosts:
      - "auth.localhost:host-gateway"
    depends_on:
      - torch-hds
    
  torch-hds:
    image: samply/blaze:1.1.2@sha256:af980162fea1c1047ffab1e51400c7a8bbe4d61d6669de0ed915198280d46878
    ports: [ ":8080" ]
    networks: [ "torch" ]
    environment:
      BASE_URL: "http://torch-hds:8080"
    healthcheck:
      test: [ "CMD", "curl", "-sSf", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
      
      
volumes:
  torch-data:

