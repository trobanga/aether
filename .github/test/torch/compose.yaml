name: torch

networks:
  torch:

services:
  torch-proxy:
      networks: [ "aether", "torch" ]
      restart: unless-stopped
      image: nginxinc/nginx-unprivileged:1.27-alpine
      ports: [ ":80" ]
      volumes:
        - ./torch.nginx.conf:/etc/nginx/nginx.conf
        - ./output:/app/output
      depends_on:
        - torch
  torch:
    restart: unless-stopped
    image: ghcr.io/medizininformatik-initiative/torch:1.0.0-alpha.11
    # image: torch:latest
    networks: [ "aether", "torch" ]
    ports:
      - ":8080"
    environment:
      TORCH_RESULTS_PERSISTENCE: PT12H30M5S
      TORCH_BUFFERSIZE: 100
      # Connection Config
      # Note: TORCH_BASE_URL should be the reverse proxy (nginx) for external access
      # Internally TORCH uses torch:8080, but clients should use the proxy
      TORCH_BASE_URL: http://torch:8080
      # Proxy points to nginx reverse proxy which routes both API and file requests
      TORCH_OUTPUT_FILE_SERVER_URL: http://torch-proxy:80
      TORCH_FLARE_URL: http://torch-flare:8080
      TORCH_FHIR_URL: http://torch-hds:8080/fhir
      # Execution variables
      JAVA_TOOL_OPTIONS: >-
        -Xmx8g
        -Dcom.sun.management.jmxremote
        -Dcom.sun.management.jmxremote.port=9010
        -Dcom.sun.management.jmxremote.rmi.port=9010
        -Dcom.sun.management.jmxremote.authenticate=false
        -Dcom.sun.management.jmxremote.ssl=false
        -Djava.rmi.server.hostname=localhost
      TORCH_USE_CQL: true
      TORCH_FHIR_DISABLE_ASYNC: true
      TORCH_BATCHSIZE: 500
      TORCH_FHIR_PAGE_COUNT: 500
      TORCH_FHIR_MAX_CONNECTIONS: 5
      TORCH_MAXCONCURRENCY: 4
      # Other
      LOG_LEVEL: trace
      
    volumes:
      - ./output:/app/output
    extra_hosts:
      - auth.localhost:host-gateway
    depends_on:
      - torch-hds
    
  torch-hds:
    image: samply/blaze:1.1.2@sha256:af980162fea1c1047ffab1e51400c7a8bbe4d61d6669de0ed915198280d46878
    ports: [ ":8080" ]
    networks: [ "torch" ]
    environment:
      BASE_URL: http://torch-hds:8080
      DB_RESOURCE_CACHE_SIZE: "100000"  # Cache up to 100K resources
      DB_MAX_SEARCH_RESULT_SIZE: "200000"  # Allow large search results
      LOG_LEVEL: debug
      JAVA_TOOL_OPTIONS: "-Xmx8g"
    healthcheck:
      test: [ "CMD", "curl", "-sSf", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
      
      
volumes:
  torch-data:

