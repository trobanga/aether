{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/trobanga/aether/schemas/bundle-chunk.json",
  "title": "FHIR Bundle Chunk",
  "description": "Schema for validating FHIR Bundle chunks created during splitting. Each chunk is a valid FHIR R4 Bundle containing a subset of the original Bundle's entries.",
  "type": "object",
  "required": ["resourceType", "type", "entry"],
  "properties": {
    "resourceType": {
      "type": "string",
      "const": "Bundle",
      "description": "Must be 'Bundle' for FHIR R4 compliance"
    },
    "id": {
      "type": "string",
      "pattern": "^.+-chunk-[0-9]+$",
      "description": "Chunk identifier in format: {originalBundleId}-chunk-{index}. Example: 'bundle-123-chunk-0'"
    },
    "type": {
      "type": "string",
      "enum": ["document", "collection"],
      "description": "Bundle type from original Bundle. Only document and collection types are supported for splitting (transaction/batch require atomic processing)."
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp from original Bundle. Optional but preserved if present in original."
    },
    "total": {
      "type": "integer",
      "minimum": 1,
      "description": "Number of entries in THIS chunk (not the original Bundle). FHIR spec requires total to match entry count."
    },
    "entry": {
      "type": "array",
      "minItems": 1,
      "description": "Array of Bundle entries. Each chunk must contain at least one entry.",
      "items": {
        "type": "object",
        "required": ["resource"],
        "properties": {
          "fullUrl": {
            "type": "string",
            "description": "Absolute or relative URL for the resource. Preserved from original Bundle entry."
          },
          "resource": {
            "type": "object",
            "required": ["resourceType"],
            "properties": {
              "resourceType": {
                "type": "string",
                "description": "FHIR resource type (Patient, Observation, Condition, etc.)"
              },
              "id": {
                "type": "string",
                "description": "Resource identifier"
              }
            },
            "description": "The actual FHIR resource. Structure varies by resourceType."
          },
          "search": {
            "type": "object",
            "description": "Search metadata (if Bundle was from search result). Optional."
          },
          "request": {
            "type": "object",
            "description": "Request metadata for transaction/batch Bundles. Not applicable for document/collection chunks."
          },
          "response": {
            "type": "object",
            "description": "Response metadata for transaction/batch Bundles. Not applicable for document/collection chunks."
          }
        }
      }
    },
    "meta": {
      "type": "object",
      "description": "Bundle metadata. Optional but may be present in original Bundle.",
      "properties": {
        "lastUpdated": {
          "type": "string",
          "format": "date-time"
        },
        "versionId": {
          "type": "string"
        }
      }
    }
  },
  "additionalProperties": true,
  "examples": [
    {
      "resourceType": "Bundle",
      "id": "patient-bundle-123-chunk-0",
      "type": "document",
      "timestamp": "2025-10-22T10:00:00Z",
      "total": 250,
      "entry": [
        {
          "fullUrl": "urn:uuid:abc-123",
          "resource": {
            "resourceType": "Patient",
            "id": "patient-001",
            "name": [
              {
                "family": "Doe",
                "given": ["John"]
              }
            ]
          }
        },
        {
          "fullUrl": "urn:uuid:def-456",
          "resource": {
            "resourceType": "Condition",
            "id": "condition-001",
            "subject": {
              "reference": "Patient/patient-001"
            },
            "code": {
              "coding": [
                {
                  "system": "http://snomed.info/sct",
                  "code": "38341003",
                  "display": "Hypertension"
                }
              ]
            }
          }
        }
      ]
    }
  ],
  "definitions": {
    "chunkMetadata": {
      "description": "Metadata specific to Bundle chunks (not part of FHIR spec, used internally by aether)",
      "type": "object",
      "properties": {
        "chunkIndex": {
          "type": "integer",
          "minimum": 0,
          "description": "Zero-based index of this chunk in the split operation"
        },
        "totalChunks": {
          "type": "integer",
          "minimum": 1,
          "description": "Total number of chunks created from original Bundle"
        },
        "originalBundleId": {
          "type": "string",
          "description": "ID of the original Bundle before splitting"
        },
        "estimatedSizeBytes": {
          "type": "integer",
          "minimum": 0,
          "description": "Estimated serialized size of this chunk in bytes"
        }
      }
    }
  },
  "notes": [
    "Chunks are designed to be valid FHIR R4 Bundles that DIMP can process independently",
    "The 'id' field uses a special format to track chunk relationships, but this is transparent to DIMP",
    "After pseudonymization, chunks are reassembled back into a single Bundle with the original ID restored",
    "The 'total' field reflects the chunk's entry count, not the original Bundle's total (per FHIR spec)",
    "Fields like 'signature' and 'link' are intentionally omitted as they are not meaningful for chunks"
  ],
  "validation": {
    "contract_test": "tests/unit/bundle_chunk_schema_test.go",
    "purpose": "Ensure every chunk created by aether can be successfully processed by DIMP",
    "enforcement": "Schema validation runs as part of unit tests and optionally at runtime (debug mode)"
  }
}
